---
title: "HAIPW Pipeline: Pooled Results"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(dplyr)
library(ranger)
library(xtable)
library(caret)
set.seed(2025)

# 1) Full-sample AIPW influence curve
compute_aipw_full <- function(X, Y, W) {
  pi_hat <- mean(W)
  df1    <- as.data.frame(cbind(Y = Y[W==1],  X = X[W==1, , drop=FALSE]))
  df0    <- as.data.frame(cbind(Y = Y[W==0],  X = X[W==0, , drop=FALSE]))
  fit1   <- lm(Y ~ ., data = df1)
  fit0   <- lm(Y ~ ., data = df0)
  mu1    <- predict(fit1, newdata = as.data.frame(X))
  mu0    <- predict(fit0, newdata = as.data.frame(X))
  mu1 - mu0 +
    (W * (Y - mu1))   / pi_hat -
    ((1 - W) * (Y - mu0)) / (1 - pi_hat)
}

# 2) Optimal-weight solver
compute_lambda <- function(Sigma) {
  ones     <- rep(1, nrow(Sigma))
  Sigma_inv <- tryCatch(
    solve(Sigma),
    error = function(e) solve(Sigma + diag(1e-10, nrow(Sigma)))
  )
  as.vector(Sigma_inv %*% ones / as.numeric(t(ones) %*% Sigma_inv %*% ones))
}

# 3) HAIPW stacking
haipw_stack <- function(df, treat_label, outcome, covariates, models) {
  W      <- as.integer(df$Treatment == treat_label)
  Y      <- df[[outcome]]
  X_mat  <- model.matrix(
    as.formula(paste0("~ ", paste(covariates, collapse = " + "))),
    data = df
  )[, -1, drop=FALSE]
  pi_hat <- mean(W)

  psi_list <- list(
    aipw = compute_aipw_full(X_mat, Y, W)
  )
  for(name in names(models)) {
    y1 <- models[[name]][1]
    y0 <- models[[name]][2]
    psi_list[[name]] <-
      (W * (Y - df[[y1]])) / pi_hat -
      ((1 - W) * (Y - df[[y0]])) / (1 - pi_hat) +
      (df[[y1]] - df[[y0]])
  }

  all_psi <- do.call(rbind, psi_list)
  Sigma   <- cov(t(all_psi))
  lambda  <- compute_lambda(Sigma)

  phi    <- colSums(t(all_psi) * lambda)
  ate    <- mean(phi)
  se_ate <- sqrt(as.numeric(t(lambda) %*% Sigma %*% lambda) / nrow(df))

  list(ate = ate, se = se_ate)
}

setwd("~/Desktop/Research/collection/SS 25/Meeting 0729/cleaned_data")
store_results <- function(trial, beta, se_beta, mse_anc, mse_cf, se_haipw, oob_mse_rf) {
  mse_list[[trial]] <<- tibble(
    Trial = trial,
    Model = c(
      "ANCOVA",
      "Counterfactual Reg.",
      "Random Forest (OOB)"
    ),
    MSE = c(mse_anc, mse_cf, oob_mse_rf)
  )
  se_list[[trial]] <<- tibble(
    Trial     = trial,
    Estimator = c("ANCOVA beta", "HAIPW ATE"),
    SE        = c(se_beta, se_haipw)
  )
}

mse_list <- list()
se_list  <- list()
```

```{r}
### Trial 2 (in‐sample MSE for LM/CF + RF OOB MSE)
{
  df2   <- fread("trial2/trial2.csv")
  chat2 <- fread("trial2/trial2_chatgpt_potential_outcomes.csv")
  ds2   <- fread("trial2/trial2_deepseek_potential_outcomes.csv")
  df2 <- df2 %>%
    mutate(
      A = ifelse(Treatment == "Ivermectin+Doxycycline", 1, 0),
      Y = YP_recovery_time
    ) %>%
    bind_cols(chat2, ds2)

  covs2 <- c(
    "X_agegrp_0d","X_sex_0d","X_fever_0d","X_cough_0d",
    "X_respdiff_0d","X_comorb_0d","X_diabetes_0d","X_hyperten_0d"
  )
  f2    <- as.formula(paste("Y ~ A +", paste(covs2, collapse = " + ")))

  # 1) ANCOVA (in‐sample MSE)
  fit2_anc <- lm(f2, data = df2)
  s2       <- summary(fit2_anc)
  beta2    <- s2$coefficients["A","Estimate"]
  se2      <- s2$coefficients["A","Std. Error"]
  df2$yhat_anc <- predict(fit2_anc, df2)
  mse2_anc <- mean((df2$yhat_anc - df2$Y)^2)

  # 2) Counterfactual regression (in‐sample MSE)
  df2_cf <- df2 %>%
    mutate(
      Z1 = ifelse(A == 0, chatgpt_y1, 0),
      Z0 = ifelse(A == 1, chatgpt_y0, 0)
    )
  fit2_cf <- lm(update(f2, . ~ . + Z1 + Z0), data = df2_cf)
  df2$yhat_cf <- predict(fit2_cf, df2_cf)
  mse2_cf <- mean((df2$yhat_cf - df2$Y)^2)

  # 3) HAIPW
  res2 <- haipw_stack(
    df2, "Ivermectin+Doxycycline", "Y", covs2,
    list(
      chatgpt = c("chatgpt_y1","chatgpt_y0"),
      deepseek = c("deepseek_y1","deepseek_y0")
    )
  )

  # 4) Random Forest — OOB MSE
  fit2_rf     <- ranger(
    formula                   = f2,
    data                      = df2,
    num.trees                 = 500,
    respect.unordered.factors = "order",
    seed                      = 2025
  )
  oob_mse2_rf <- fit2_rf$prediction.error

  # 5) Bootstrap SE of the CF‐regression ATE (B = 500)
  B              <- 500
  boot_cf_ates2  <- numeric(0)
  while (length(boot_cf_ates2) < B) {
    idx    <- sample(nrow(df2_cf), replace = TRUE)
    bdf_cf <- df2_cf[idx, ]
    fit_b  <- lm(update(f2, . ~ . + Z1 + Z0), data = bdf_cf)
    coefs  <- coef(fit_b)
    cf_try <- coefs["A"] +
              coefs["Z1"] * mean(bdf_cf$Z1) -
              coefs["Z0"] * mean(bdf_cf$Z0)
    if (!is.na(cf_try)) boot_cf_ates2 <- c(boot_cf_ates2, cf_try)
  }
  se2_cf_boot <- sd(boot_cf_ates2)

  # Store results: in‐sample MSEs for LM/CF, OOB MSE for RF
  store_results(
    "2",
    beta2,
    se2,
    mse2_anc,
    mse2_cf,
    res2$se,
    oob_mse2_rf
  )

  # Append CF bootstrap SE
  se_list[["2"]] <- bind_rows(
    se_list[["2"]],
    tibble(Trial = "2", Estimator = "CF Bootstrap", SE = se2_cf_boot)
  )
}

# Quick check
cat("ANCOVA in‐sample MSE:  ", round(mse2_anc, 3), "\n")
cat("CF in‐sample MSE:      ", round(mse2_cf, 3),   "\n")
cat("RF    OOB MSE:         ", round(oob_mse2_rf, 3), "\n")

```

```{r}
### Trial 4 (in‐sample MSE for LM/CF + RF OOB MSE)
{
  df4 <- fread("trial4/trial4_cf.csv") %>%
    mutate(
      A = ifelse(Treatment == "VD", 1, 0),
      Y = YP_delta_P3NP_6w
    )

  covs4 <- c(
    "X_Sex_0w","X_Age_0w","X_BMI_0w","X_FIB4_0w",
    "X_APRI_0w","X_VD_0w","X_AST_0w","X_ALT_0w",
    "X_Plt_0w","X_TGF_0w","X_TIMP_0w","X_MMP_0w","X_P3NP_0w"
  )
  f4    <- as.formula(paste("Y ~ A +", paste(covs4, collapse = " + ")))

  # 1) ANCOVA (in‐sample)
  fit4_anc <- lm(f4, data = df4)
  s4       <- summary(fit4_anc)
  beta4    <- s4$coefficients["A","Estimate"]
  se4      <- s4$coefficients["A","Std. Error"]
  df4$yhat_anc <- predict(fit4_anc, df4)
  mse4_anc <- mean((df4$yhat_anc - df4$Y)^2)

  # 2) Counterfactual regression (in‐sample)
  df4_cf <- df4 %>%
    mutate(
      Z1 = ifelse(A == 0, chatgpt_cf_VitD2, 0),
      Z0 = ifelse(A == 1, chatgpt_cf_Placebo, 0)
    )
  fit4_cf   <- lm(update(f4, . ~ . + Z1 + Z0), data = df4_cf)
  df4$yhat_cf <- predict(fit4_cf, df4_cf)
  mse4_cf   <- mean((df4$yhat_cf - df4$Y)^2)

  # 3) HAIPW
  res4 <- haipw_stack(
    df4, "VD", "Y", covs4,
    list(
      chatgpt  = c("chatgpt_cf_VitD2","chatgpt_cf_Placebo"),
      deepseek = c("deepseek_cf_VitD2","deepseek_cf_Placebo")
    )
  )

  # 4) Random Forest – OOB MSE
  fit4_rf     <- ranger(
    formula                   = f4,
    data                      = df4,
    num.trees                 = 500,
    respect.unordered.factors = "order",
    seed                      = 2025
  )
  oob_mse4_rf <- fit4_rf$prediction.error

  # 5) Bootstrap SE of the CF‐regression ATE (B = 500)
  B        <- 500
  boot_cf4 <- numeric(0)
  while(length(boot_cf4) < B) {
    idx    <- sample(nrow(df4_cf), replace = TRUE)
    bdf_cf <- df4_cf[idx, ]
    fit_b  <- lm(update(f4, . ~ . + Z1 + Z0), data = bdf_cf)
    coefs  <- coef(fit_b)
    cf_try <- coefs["A"] +
              coefs["Z1"] * mean(bdf_cf$Z1) -
              coefs["Z0"] * mean(bdf_cf$Z0)
    if (!is.na(cf_try)) boot_cf4 <- c(boot_cf4, cf_try)
  }
  se4_cf_boot <- sd(boot_cf4)

  # Store results: in‐sample MSE for LM/CF, OOB MSE for RF
  store_results(
    "4",
    beta4,
    se4,
    mse4_anc,
    mse4_cf,
    res4$se,
    oob_mse4_rf
  )

  # Append CF bootstrap SE
  se_list[["4"]] <- bind_rows(
    se_list[["4"]],
    tibble(Trial = "4", Estimator = "CF Bootstrap", SE = se4_cf_boot)
  )
}

# Quick check
cat("ANCOVA in‐sample MSE: ", round(mse4_anc, 3), "\n")
cat("CF in‐sample MSE:     ", round(mse4_cf, 3),   "\n")
cat("RF OOB MSE:          ", round(oob_mse4_rf, 3), "\n")

```


```{r}
### Trial 6 (with CF‐regression bootstrap SE, Random Forest, and out‐of‐sample MSEs)
{
  library(data.table)
  library(dplyr)
  library(ranger)

  cf6 <- fread("trial6/trial6_counterfactuals.csv") %>%
    mutate(
      W = ifelse(Treatment == "Sitagliptin", 1, 0),
      Y = YP_delta_CCA_IMT_24m
    ) %>%
    drop_na()

  covs6 <- grep("_0m$", names(cf6), value = TRUE)
  f6 <- if (length(covs6) > 0) {
    as.formula(paste("Y ~ W +", paste(covs6, collapse = " + ")))
  } else {
    as.formula("Y ~ W")
  }

  # 1) ANCOVA (in-sample)
  fit6_anc    <- lm(f6, data = cf6)
  s6          <- summary(fit6_anc)
  beta6       <- s6$coefficients["W","Estimate"]
  se6         <- s6$coefficients["W","Std. Error"]
  cf6$yhat6_anc <- predict(fit6_anc, cf6)
  mse6_anc    <- mean((cf6$yhat6_anc - cf6$Y)^2)

  # 2) Counterfactual regression (in-sample)
  cf6_cf <- cf6 %>%
    mutate(
      Z1 = ifelse(W == 0, chat_sitagliptin_delta, 0),
      Z0 = ifelse(W == 1, chat_conventional_delta, 0)
    )
  fit6_cf     <- lm(update(f6, . ~ . + Z1 + Z0), data = cf6_cf)
  cf6$yhat6_cf <- predict(fit6_cf, cf6_cf)
  mse6_cf     <- mean((cf6$yhat6_cf - cf6$Y)^2)

  # 3) HAIPW
  res6 <- haipw_stack(
    cf6, "Sitagliptin", "Y", covs6,
    list(
      chatgpt = c("chat_sitagliptin_delta","chat_conventional_delta"),
      deepseek = c("ds_sitagliptin_delta","ds_conventional_delta")
    )
  )

  # 4) Random Forest – OOB MSE
  fit6_rf     <- ranger(
    formula                   = f6,
    data                      = cf6,
    num.trees                 = 500,
    respect.unordered.factors = "order",
    seed                      = 2025
  )
  oob_mse6_rf <- fit6_rf$prediction.error

  # 5) Bootstrap SE of CF-regression ATE (B = 500)
  B <- 500
  boot_cf6 <- numeric(0)
  while (length(boot_cf6) < B) {
    idx    <- sample(nrow(cf6_cf), replace = TRUE)
    bdf_cf <- cf6_cf[idx, ]
    fit_b  <- lm(update(f6, . ~ . + Z1 + Z0), data = bdf_cf)
    coefs  <- coef(fit_b)
    cf_try <- coefs["W"] +
              coefs["Z1"] * mean(bdf_cf$Z1) -
              coefs["Z0"] * mean(bdf_cf$Z0)
    if (!is.na(cf_try)) boot_cf6 <- c(boot_cf6, cf_try)
  }
  se6_cf_boot <- sd(boot_cf6)

  # Store results: in-sample MSEs for LM/CF, RF's OOB MSE
  store_results(
    "6",
    beta6,
    se6,
    mse6_anc,
    mse6_cf,
    res6$se,
    oob_mse6_rf
  )

  # Append CF bootstrap SE
  se_list[["6"]] <- bind_rows(
    se_list[["6"]],
    tibble(Trial = "6", Estimator = "CF Bootstrap", SE = se6_cf_boot)
  )
}

# Inspect
cat("ANCOVA in-sample MSE: ", round(mse6_anc, 3), "\n")
cat("CF     in-sample MSE: ", round(mse6_cf, 3),   "\n")
cat("RF         OOB MSE:  ", round(oob_mse6_rf, 3), "\n")


```



```{r}
### Trial 14 (in-sample MSE for LM/CF + RF OOB MSE)
{
  library(data.table)
  library(dplyr)
  library(ranger)

  cf14 <- fread("trial14/trial14_counterfactuals.csv")
  df14 <- cf14 %>%
    mutate(
      A = ifelse(Treatment == "TERECO", 1, 0),
      Y = YP_6MWD_28w - X_6MWD_0w
    ) %>%
    drop_na()

  covs14 <- grep("_0w$", names(df14), value = TRUE)
  f14     <- if (length(covs14) > 0) {
    as.formula(paste("Y ~ A +", paste(covs14, collapse = " + ")))
  } else {
    as.formula("Y ~ A")
  }

  # 1) ANCOVA (in-sample)
  fit14_anc    <- lm(f14, data = df14)
  s14          <- summary(fit14_anc)
  beta14       <- s14$coefficients["A","Estimate"]
  se14         <- s14$coefficients["A","Std. Error"]
  df14$yhat_anc <- predict(fit14_anc, df14)
  mse14_anc    <- mean((df14$yhat_anc - df14$Y)^2)

  # 2) Counterfactual regression (in-sample)
  df14_cf <- df14 %>%
    mutate(
      Z1 = ifelse(A == 0, chat_treatment_delta, 0),
      Z0 = ifelse(A == 1, chat_control_delta,   0)
    )
  fit14_cf     <- lm(update(f14, . ~ . + Z1 + Z0), data = df14_cf)
  df14$yhat_cf <- predict(fit14_cf, df14_cf)
  mse14_cf     <- mean((df14$yhat_cf - df14$Y)^2)

  # 3) HAIPW
  res14 <- haipw_stack(
    df14, "TERECO", "Y", covs14,
    list(
      chatgpt  = c("chat_treatment_delta","chat_control_delta"),
      deepseek = c("ds_treatment_delta","ds_control_delta")
    )
  )

  # 4) Random Forest – OOB MSE
  fit14_rf     <- ranger(
    formula                   = f14,
    data                      = df14,
    num.trees                 = 500,
    respect.unordered.factors = "order",
    seed                      = 2025
  )
  oob_mse14_rf <- fit14_rf$prediction.error

  # 5) Bootstrap SE of CF-regression ATE (B = 500)
  B           <- 500
  boot_cf14   <- numeric(0)
  while (length(boot_cf14) < B) {
    idx    <- sample(nrow(df14_cf), replace = TRUE)
    bdf_cf <- df14_cf[idx, ]
    fit_b  <- lm(update(f14, . ~ . + Z1 + Z0), data = bdf_cf)
    coefs  <- coef(fit_b)
    cf_try <- coefs["A"] +
              coefs["Z1"] * mean(bdf_cf$Z1) -
              coefs["Z0"] * mean(bdf_cf$Z0)
    if (!is.na(cf_try)) boot_cf14 <- c(boot_cf14, cf_try)
  }
  se14_cf_boot <- sd(boot_cf14)

  # Store results: in-sample MSE for LM/CF, RF OOB MSE
  store_results(
    "14",
    beta14,
    se14,
    mse14_anc,
    mse14_cf,
    res14$se,
    oob_mse14_rf
  )

  # Append CF bootstrap SE
  se_list[["14"]] <- bind_rows(
    se_list[["14"]],
    tibble(Trial = "14", Estimator = "CF Bootstrap", SE = se14_cf_boot)
  )
}

# Quick check
cat("ANCOVA in-sample MSE:  ", round(mse14_anc, 3), "\n")
cat("CF    in-sample MSE:  ", round(mse14_cf, 3),   "\n")
cat("RF    OOB MSE:        ", round(oob_mse14_rf, 3), "\n")
```

```{r}


### Trial 17 (in‐sample MSE for LM/CF + RF OOB MSE)
{
  library(data.table)
  library(dplyr)
  library(ranger)

  set.seed(2025)
  cf17 <- fread("trial17/trial17_counterfactuals.csv")
  df17 <- cf17 %>%
    mutate(
      A = ifelse(Treatment == "statin_pcsk9", 1, 0),
      Y = YP_delta_LDL_24w
    ) %>%
    drop_na()

  covs17 <- grep("_0w$", names(df17), value = TRUE)
  f17     <- as.formula(paste("Y ~ A +", paste(covs17, collapse = " + ")))

  # 1) ANCOVA (in‐sample MSE)
  fit17_anc     <- lm(f17, data = df17)
  s17           <- summary(fit17_anc)
  beta17        <- s17$coefficients["A","Estimate"]
  se17          <- s17$coefficients["A","Std. Error"]
  df17$yhat17_anc <- predict(fit17_anc, df17)
  mse17_anc     <- mean((df17$yhat17_anc - df17$Y)^2)

  # 2) Counterfactual regression (in‐sample MSE)
  df17_cf <- df17 %>%
    mutate(
      Z1 = ifelse(A == 0, chat_treatment_delta, 0),
      Z0 = ifelse(A == 1, chat_control_delta,   0)
    )
  fit17_cf      <- lm(update(f17, . ~ . + Z1 + Z0), data = df17_cf)
  df17$yhat17_cf <- predict(fit17_cf, df17_cf)
  mse17_cf      <- mean((df17$yhat17_cf - df17$Y)^2)

  # 3) HAIPW stacking
  res17 <- haipw_stack(
    df17, "statin_pcsk9", "Y", covs17,
    list(
      chatgpt = c("chat_treatment_delta","chat_control_delta"),
      deepseek = c("ds_treatment_delta","ds_control_delta")
    )
  )

  # 4) Random Forest – OOB MSE (and optional in‐sample one‐liner)
  fit17_rf         <- ranger(
    formula                   = f17,
    data                      = df17,
    num.trees                 = 500,
    respect.unordered.factors = "order",
    seed                      = 2025
  )
  oob_mse17_rf     <- fit17_rf$prediction.error
  mse17_rf_insample <- mean((df17$Y - predict(fit17_rf, df17)$predictions)^2)

  # 5) Bootstrap SE of CF‐regression ATE (B = 500)
  B             <- 500
  boot_cf_17    <- numeric(0)
  while (length(boot_cf_17) < B) {
    idx    <- sample(nrow(df17_cf), replace = TRUE)
    bdf_cf <- df17_cf[idx, ]
    fit_b  <- lm(update(f17, . ~ . + Z1 + Z0), data = bdf_cf)
    coefs  <- coef(fit_b)
    cf_try <- coefs["A"] +
              coefs["Z1"] * mean(bdf_cf$Z1) -
              coefs["Z0"] * mean(bdf_cf$Z0)
    if (!is.na(cf_try)) boot_cf_17 <- c(boot_cf_17, cf_try)
  }
  se17_cf_boot <- sd(boot_cf_17)

  # Store results: in‐sample MSEs for LM/CF, RF OOB MSE
  store_results(
    "17",
    beta17,
    se17,
    mse17_anc,
    mse17_cf,
    res17$se,
    oob_mse17_rf
  )

  # Append CF bootstrap SE
  se_list[["17"]] <- bind_rows(
    se_list[["17"]],
    tibble(Trial = "17", Estimator = "CF Bootstrap", SE = se17_cf_boot)
  )
}

# Quick check
cat("ANCOVA in‐sample MSE: ", round(mse17_anc, 3), "\n")
cat("CF    in‐sample MSE: ", round(mse17_cf, 3), "\n")
cat("RF    OOB   MSE: ", round(oob_mse17_rf, 3), "\n")


```


```{r}

### Trial 18 (in-sample MSE for LM/CF + RF OOB MSE)
{
  library(data.table)
  library(dplyr)
  library(ranger)

  set.seed(2025)

  # Load and preprocess
  cf18 <- fread("trial18/trial18_counterfactuals.csv") %>%
    mutate(
      A = ifelse(Treatment == "Kanyakla", 1, 0),
      Y = YP_time_to_disengaged_12m
    ) %>%
    drop_na()

  covs18 <- grep("_0m$", names(cf18), value = TRUE)
  f18 <- if (length(covs18) > 0) {
    as.formula(paste("Y ~ A +", paste(covs18, collapse = " + ")))
  } else {
    as.formula("Y ~ A")
  }

  # 1) ANCOVA (in-sample)
  fit18_anc     <- lm(f18, data = cf18)
  s18_anc       <- summary(fit18_anc)
  beta18        <- s18_anc$coefficients["A", "Estimate"]
  se18_beta     <- s18_anc$coefficients["A", "Std. Error"]
  cf18$yhat18_anc <- predict(fit18_anc, cf18)
  mse18_anc     <- mean((cf18$yhat18_anc - cf18$Y)^2)

  # 2) Counterfactual regression (in-sample)
  cf18_cf <- cf18 %>%
    mutate(
      Z1 = ifelse(A == 0, chat_intervention_days, 0),
      Z0 = ifelse(A == 1, chat_control_days,      0)
    )
  fit18_cf      <- lm(update(f18, . ~ . + Z1 + Z0), data = cf18_cf)
  cf18$yhat18_cf <- predict(fit18_cf, cf18_cf)
  mse18_cf      <- mean((cf18$yhat18_cf - cf18$Y)^2)

  # 3) HAIPW stacking
  res18 <- haipw_stack(
    cf18, "Kanyakla", "Y", covs18,
    list(
      chatgpt  = c("chat_intervention_days","chat_control_days"),
      deepseek = c("ds_intervention_days",   "ds_control_days")
    )
  )

  # 4) Random Forest – OOB MSE
  fit18_rf     <- ranger(
    formula                   = f18,
    data                      = cf18,
    num.trees                 = 500,
    respect.unordered.factors = "order",
    seed                      = 2025
  )
  oob_mse18_rf <- fit18_rf$prediction.error

  # 5) Bootstrap SE of CF-regression ATE (B = 500)
  B          <- 500
  boot_cf18  <- numeric(0)
  while (length(boot_cf18) < B) {
    idx    <- sample(nrow(cf18_cf), replace = TRUE)
    bdf_cf <- cf18_cf[idx, ]
    fit_b  <- lm(update(f18, . ~ . + Z1 + Z0), data = bdf_cf)
    coefs  <- coef(fit_b)
    cf_try <- coefs["A"] +
              coefs["Z1"] * mean(bdf_cf$Z1) -
              coefs["Z0"] * mean(bdf_cf$Z0)
    if (!is.na(cf_try)) boot_cf18 <- c(boot_cf18, cf_try)
  }
  se18_cf_boot <- sd(boot_cf18)

  # 6) Store results: in-sample MSEs for LM/CF, RF OOB MSE
  store_results(
    "18",
    beta18,
    se18_beta,
    mse18_anc,
    mse18_cf,
    res18$se,
    oob_mse18_rf
  )

  # 7) Append CF bootstrap SE
  se_list[["18"]] <- bind_rows(
    se_list[["18"]],
    tibble(Trial = "18", Estimator = "CF Bootstrap", SE = se18_cf_boot)
  )
}

# Quick check
cat("ANCOVA in-sample MSE: ", round(mse18_anc, 3), "\n")
cat("CF    in-sample MSE: ", round(mse18_cf, 3), "\n")
cat("RF    OOB MSE:      ", round(oob_mse18_rf, 3), "\n")

```

````{r}
### Trial 19 (in‐sample MSE for LM/CF + RF OOB MSE)
{
  library(data.table)
  library(dplyr)
  library(ranger)

  df19   <- fread("trial19/trial19.csv")
  chat19 <- fread("trial19/trial19_chatgpt_potential_outcomes.csv")
  ds19   <- fread("trial19/trial19_deepseek_potential_outcomes.csv")

  df19 <- df19 %>%
    mutate(
      A = ifelse(Treatment == "Piggyback", 1, 0),
      Y = YP_FHVP_CVP_GRADIENT
    ) %>%
    bind_cols(chat19, ds19) %>%
    drop_na()

  covs19 <- c(
    "X_RECIPIENT_AGE_YEARS_0d","X_RECIPIENT_GENDER_0d",
    "X_MELD_SCORE_0d","X_CREATININE_0d",
    "X_DONOR_AGE_YEARS_0d","X_GRAFT_SHARING_0d"
  )
  f19 <- as.formula(paste("Y ~ A +", paste(covs19, collapse = " + ")))

  # 1) ANCOVA (in‐sample)
  fit19_anc     <- lm(f19, data = df19)
  s19           <- summary(fit19_anc)
  beta19        <- s19$coefficients["A","Estimate"]
  se19          <- s19$coefficients["A","Std. Error"]
  df19$yhat19_anc <- predict(fit19_anc, df19)
  mse19_anc     <- mean((df19$yhat19_anc - df19$Y)^2)

  # 2) Counterfactual regression (in‐sample)
  df19_cf <- df19 %>%
    mutate(
      Z1 = ifelse(A == 0, chatgpt_piggyback,    0),
      Z0 = ifelse(A == 1, chatgpt_conventional, 0)
    )
  fit19_cf      <- lm(update(f19, . ~ . + Z1 + Z0), data = df19_cf)
  df19$yhat19_cf <- predict(fit19_cf, df19_cf)
  mse19_cf      <- mean((df19$yhat19_cf - df19$Y)^2)

  # 3) HAIPW stacking
  res19 <- haipw_stack(
    df19, "Piggyback", "Y", covs19,
    list(
      chatgpt = c("chatgpt_piggyback","chatgpt_conventional"),
      deepseek = c("deepseek_piggyback","deepseek_conventional")
    )
  )

  # 4) Random Forest – OOB MSE
  fit19_rf      <- ranger(
    formula                   = f19,
    data                      = df19,
    num.trees                 = 500,
    respect.unordered.factors = "order",
    seed                      = 2025
  )
  oob_mse19_rf  <- fit19_rf$prediction.error

  # 5) Bootstrap SE of CF‐regression ATE (B = 500)
  B            <- 500
  boot_cf19    <- numeric(0)
  while (length(boot_cf19) < B) {
    idx    <- sample(nrow(df19_cf), replace = TRUE)
    bdf_cf <- df19_cf[idx, ]
    fit_b  <- lm(update(f19, . ~ . + Z1 + Z0), data = bdf_cf)
    coefs  <- coef(fit_b)
    cf_try <- coefs["A"] +
              coefs["Z1"] * mean(bdf_cf$Z1) -
              coefs["Z0"] * mean(bdf_cf$Z0)
    if (!is.na(cf_try)) boot_cf19 <- c(boot_cf19, cf_try)
  }
  se19_cf_boot <- sd(boot_cf19)

  # Store results: in‐sample MSE for LM/CF, HAIPW SE, RF OOB MSE
  store_results(
    "19",
    beta19,
    se19,
    mse19_anc,
    mse19_cf,
    res19$se,
    oob_mse19_rf
  )

  # Append CF bootstrap SE
  se_list[["19"]] <- bind_rows(
    se_list[["19"]],
    tibble(Trial = "19", Estimator = "CF Bootstrap", SE = se19_cf_boot)
  )
}

# Quick check
cat("ANCOVA in‐sample MSE:  ", round(mse19_anc, 3), "\n")
cat("CF    in‐sample MSE:  ", round(mse19_cf, 3),   "\n")
cat("RF    OOB   MSE:      ", round(oob_mse19_rf, 3), "\n")

```

```{r}

### Trial 26 (in‐sample MSE for LM/CF + RF OOB MSE)
{
  library(data.table)
  library(dplyr)
  library(ranger)

  set.seed(2025)

  # Load & preprocess
  df26   <- fread("trial26/trial26.csv")
  chat26 <- fread("trial26/trial26_chatgpt_potential_adherence.csv")
  ds26   <- fread("trial26/trial26_deepseek_potential_adherence.csv")
  df26 <- df26 %>%
    mutate(
      A = ifelse(Treatment == "Reminder module", 1, 0),
      Y = YP_delta_Adherence_6m
    ) %>%
    bind_cols(chat26, ds26) %>%
    drop_na()

  covs26 <- c(
    "X_Agecat_0m","X_Education_0m","X_Ethnicity_0m","X_Socialsupport_0m",
    "X_TB_status_0m","X_OI_index_0m","X_weight_0m","X_CD4_0m",
    "X_viral_load_0m","X_Adherence_0m"
  )
  f26 <- as.formula(paste("Y ~ A +", paste(covs26, collapse = " + ")))

  # 1) ANCOVA (in‐sample)
  fit26_anc    <- lm(f26, data = df26)
  s26          <- summary(fit26_anc)
  beta26       <- s26$coefficients["A","Estimate"]
  se26         <- s26$coefficients["A","Std. Error"]
  df26$yhat26_anc <- predict(fit26_anc, df26)
  mse26_anc    <- mean((df26$yhat26_anc - df26$Y)^2)

  # 2) Counterfactual regression (in‐sample)
  df26_cf <- df26 %>%
    mutate(
      Z1 = ifelse(A == 0, chatgpt_deltaadh_6m_1, 0),
      Z0 = ifelse(A == 1, chatgpt_deltaadh_6m_0, 0)
    )
  fit26_cf       <- lm(update(f26, . ~ . + Z1 + Z0), data = df26_cf)
  df26$yhat26_cf <- predict(fit26_cf, df26_cf)
  mse26_cf       <- mean((df26$yhat26_cf - df26$Y)^2)

  # 3) HAIPW
  res26 <- haipw_stack(
    df26, "Reminder module", "Y", covs26,
    list(
      chatgpt = c("chatgpt_deltaadh_6m_1","chatgpt_deltaadh_6m_0"),
      deepseek = c("deepseek_deltaadh_6m_1","deepseek_deltaadh_6m_0")
    )
  )

  # 4) Random Forest – OOB MSE
  fit26_rf      <- ranger(
    formula                   = f26,
    data                      = df26,
    num.trees                 = 500,
    respect.unordered.factors = "order",
    seed                      = 2025
  )
  oob_mse26_rf  <- fit26_rf$prediction.error

  # 5) Bootstrap SE for CF‐regression ATE (B = 500)
  B          <- 500
  boot_cf26  <- numeric(0)
  while (length(boot_cf26) < B) {
    idx    <- sample(nrow(df26_cf), replace = TRUE)
    bdf_cf <- df26_cf[idx, ]
    fit_b  <- lm(update(f26, . ~ . + Z1 + Z0), data = bdf_cf)
    coefs  <- coef(fit_b)
    cf_try <- coefs["A"] +
              coefs["Z1"] * mean(bdf_cf$Z1) -
              coefs["Z0"] * mean(bdf_cf$Z0)
    if (!is.na(cf_try)) boot_cf26 <- c(boot_cf26, cf_try)
  }
  se26_cf_boot <- sd(boot_cf26)

  # Store results: in‐sample MSEs for LM/CF, RF OOB MSE
  store_results(
    "26",
    beta26,
    se26,
    mse26_anc,
    mse26_cf,
    res26$se,
    oob_mse26_rf
  )

  # Append CF bootstrap SE
  se_list[["26"]] <- bind_rows(
    se_list[["26"]],
    tibble(Trial = "26", Estimator = "CF Bootstrap", SE = se26_cf_boot)
  )
}

# Quick check
cat("ANCOVA in‐sample MSE: ", round(mse26_anc, 3), "\n")
cat("CF    in‐sample MSE: ", round(mse26_cf, 3),   "\n")
cat("RF    OOB   MSE: ", round(oob_mse26_rf, 3),    "\n")

```

```{r}

### Trial 33 (in‐sample MSE for LM/CF + RF OOB MSE)
library(data.table)
library(dplyr)
library(ranger)

set.seed(2025)

# ───────────────────────────────────────────────────────────────────────────────
# Trial 33 – Original predictions (unconditional chatgpt_y1 / chatgpt_y0)
# ───────────────────────────────────────────────────────────────────────────────
cf33_orig <- fread("trial 33/trial33_gpt-4.1_counterfactuals.csv") %>%
  mutate(
    A = ifelse(Treatment == "Reframing", 1, 0),
    Y = YP_TM_total_score
  ) %>%
  drop_na(A, Y) %>%
  rename(
    chatgpt_y1 = `gpt-4.1_TMscore_6m_R`,
    chatgpt_y0 = `gpt-4.1_TMscore_6m_S`
  )

covs33 <- grep("_0w$", names(cf33_orig), value = TRUE)
f33    <- if (length(covs33) > 0) {
             as.formula(paste("Y ~ A +", paste(covs33, collapse = " + ")))
          } else {
             as.formula("Y ~ A")
          }

# 1) ANCOVA (in‐sample)
fit33_anc      <- lm(f33, data = cf33_orig)
s33_anc        <- summary(fit33_anc)
beta33         <- s33_anc$coefficients["A", "Estimate"]
se33_beta      <- s33_anc$coefficients["A", "Std. Error"]
cf33_orig$yhat <- predict(fit33_anc, cf33_orig)
mse33_anc      <- mean((cf33_orig$yhat - cf33_orig$Y)^2)

# 2) Counterfactual regression (in‐sample)
cf33_cf <- cf33_orig %>%
  mutate(
    Z1 = ifelse(A == 0, chatgpt_y1, 0),
    Z0 = ifelse(A == 1, chatgpt_y0, 0)
  )
fit33_cf      <- lm(update(f33, . ~ . + Z1 + Z0), data = cf33_cf)
cf33_orig$yhat_cf <- predict(fit33_cf, cf33_cf)
mse33_cf      <- mean((cf33_orig$yhat_cf - cf33_orig$Y)^2)

# 3) HAIPW stacking
res33_orig <- haipw_stack(
  cf33_orig, "Reframing", "Y", covs33,
  list(chatgpt = c("chatgpt_y1","chatgpt_y0"))
)

# 4) Random Forest – OOB MSE
fit33_rf     <- ranger(
  formula                   = f33,
  data                      = cf33_orig,
  num.trees                 = 500,
  respect.unordered.factors = "order",
  seed                      = 2025
)
oob_mse33_rf <- fit33_rf$prediction.error

# 5) Bootstrap SE of CF‐ATE (B = 500)
B           <- 500
boot33      <- numeric(0)
while (length(boot33) < B) {
  idx    <- sample(nrow(cf33_cf), replace = TRUE)
  bdf    <- cf33_cf[idx, ]
  fit_b  <- lm(update(f33, . ~ . + Z1 + Z0), data = bdf)
  coefs  <- coef(fit_b)
  cf_try <- coefs["A"] +
            coefs["Z1"] * mean(bdf$Z1) -
            coefs["Z0"] * mean(bdf$Z0)
  if (!is.na(cf_try)) boot33 <- c(boot33, cf_try)
}
se33_cf_boot <- sd(boot33)

# Store original‐file results
store_results(
  "33_orig",
  beta33,
  se33_beta,
  mse33_anc,
  mse33_cf,
  res33_orig$se,
  oob_mse33_rf
)
se_list[["33_orig"]] <- bind_rows(
  se_list[["33_orig"]],
  tibble(Trial = "33_orig", Estimator = "CF Bootstrap", SE = se33_cf_boot)
)

cat("### Original file metrics ###\n")
cat("ANCOVA MSE: ", round(mse33_anc, 3), "\n")
cat("CF    MSE: ", round(mse33_cf,  3), "\n")
cat("RF OOB MSE: ", round(oob_mse33_rf, 3), "\n\n")


# ───────────────────────────────────────────────────────────────────────────────
# Trial 33 – Updated CF‐only predictions (single chatgpt_cf column)
# ───────────────────────────────────────────────────────────────────────────────
cf33_upd <- fread("trial 33/trial33_gpt-4.1_counterfactuals_updated.csv") %>%
  mutate(
    A       = ifelse(Treatment == "Reframing", 1, 0),
    Y       = YP_TM_total_score,
    chat_cf = `gpt-4.1_TMscore_6m_cf`
  ) %>%
  drop_na(A, Y, chat_cf) %>%
  # reconstruct both potential‐outcome columns:
  mutate(
    chatgpt_y1 = ifelse(A == 1, Y, chat_cf),
    chatgpt_y0 = ifelse(A == 0, Y, chat_cf)
  )

covs33_upd <- grep("_0w$", names(cf33_upd), value = TRUE)
f33_upd    <- if (length(covs33_upd) > 0) {
                as.formula(paste("Y ~ A +", paste(covs33_upd, collapse = " + ")))
             } else {
                as.formula("Y ~ A")
             }

# 1) ANCOVA
fit33u_anc      <- lm(f33_upd, data = cf33_upd)
s33u_anc        <- summary(fit33u_anc)
beta33u         <- s33u_anc$coefficients["A", "Estimate"]
se33u_beta      <- s33u_anc$coefficients["A", "Std. Error"]
cf33_upd$yhat   <- predict(fit33u_anc, cf33_upd)
mse33u_anc      <- mean((cf33_upd$yhat - cf33_upd$Y)^2)

# 2) CF regression
cf33u_cf <- cf33_upd %>%
  mutate(
    Z1 = ifelse(A == 0, chatgpt_y1, 0),
    Z0 = ifelse(A == 1, chatgpt_y0, 0)
  )
fit33u_cf      <- lm(update(f33_upd, . ~ . + Z1 + Z0), data = cf33u_cf)
cf33_upd$yhat_cf <- predict(fit33u_cf, cf33u_cf)
mse33u_cf      <- mean((cf33_upd$yhat_cf - cf33_upd$Y)^2)

# 3) HAIPW stacking
res33_upd <- haipw_stack(
  cf33_upd, "Reframing", "Y", covs33_upd,
  list(chatgpt = c("chatgpt_y1","chatgpt_y0"))
)

# 4) RF – OOB MSE
fit33u_rf     <- ranger(
  formula                   = f33_upd,
  data                      = cf33_upd,
  num.trees                 = 500,
  respect.unordered.factors = "order",
  seed                      = 2025
)
oob_mse33u_rf <- fit33u_rf$prediction.error

# 5) Bootstrap SE of CF‐ATE
boot33u      <- numeric(0)
while (length(boot33u) < B) {
  idx    <- sample(nrow(cf33u_cf), replace = TRUE)
  bdf    <- cf33u_cf[idx, ]
  fit_b  <- lm(update(f33_upd, . ~ . + Z1 + Z0), data = bdf)
  coefs  <- coef(fit_b)
  cf_try <- coefs["A"] +
            coefs["Z1"] * mean(bdf$Z1) -
            coefs["Z0"] * mean(bdf$Z0)
  if (!is.na(cf_try)) boot33u <- c(boot33u, cf_try)
}
se33u_cf_boot <- sd(boot33u)

# Store updated‐file results
store_results(
  "33_upd",
  beta33u,
  se33u_beta,
  mse33u_anc,
  mse33u_cf,
  res33_upd$se,
  oob_mse33u_rf
)
se_list[["33_upd"]] <- bind_rows(
  se_list[["33_upd"]],
  tibble(Trial = "33_upd", Estimator = "CF Bootstrap", SE = se33u_cf_boot)
)

cat("### Updated CF‐only file metrics ###\n")
cat("ANCOVA MSE: ", round(mse33u_anc, 3), "\n")
cat("CF    MSE: ", round(mse33u_cf,  3), "\n")
cat("RF OOB MSE: ", round(oob_mse33u_rf, 3), "\n")


```

```{r}

### Trial 36 (in-sample MSE for LM/CF + RF OOB MSE)
{
  library(data.table)
  library(dplyr)
  library(ranger)

  set.seed(2025)

  # Load & preprocess
  cf36 <- fread("trial 36/trial36_gpt-4.1_counterfactuals.csv") %>%
    mutate(
      A = ifelse(Treatment == "PI", 1, 0),
      Y = YP_delta_AttentionExe_12m
    ) %>%
    drop_na(Y) %>%
    rename(
      chatgpt_y1 = `gpt-4.1_ΔAttentionExe_12m_PI`,
      chatgpt_y0 = `gpt-4.1_ΔAttentionExe_12m_ACI`
    )

  covs36 <- grep("_0m$", names(cf36), value = TRUE)
  f36 <- if (length(covs36) > 0) {
    as.formula(paste("Y ~ A +", paste(covs36, collapse = " + ")))
  } else {
    as.formula("Y ~ A")
  }

  # 1) ANCOVA (in-sample)
  fit36_anc    <- lm(f36, data = cf36)
  s36_anc      <- summary(fit36_anc)
  beta36       <- s36_anc$coefficients["A","Estimate"]
  se36_beta    <- s36_anc$coefficients["A","Std. Error"]
  cf36$yhat36_anc <- predict(fit36_anc, cf36)
  mse36_anc    <- mean((cf36$yhat36_anc - cf36$Y)^2)

  # 2) Counterfactual regression (in-sample)
  cf36_cf <- cf36 %>%
    mutate(
      Z1 = ifelse(A == 0, chatgpt_y1, 0),
      Z0 = ifelse(A == 1, chatgpt_y0, 0)
    )
  fit36_cf     <- lm(update(f36, . ~ . + Z1 + Z0), data = cf36_cf)
  cf36$yhat36_cf <- predict(fit36_cf, cf36_cf)
  mse36_cf     <- mean((cf36$yhat36_cf - cf36$Y)^2)

  # 3) HAIPW stacking
  res36 <- haipw_stack(
    cf36, "PI", "Y", covs36,
    list(chatgpt = c("chatgpt_y1","chatgpt_y0"))
  )

  # 4) Random Forest – OOB MSE (plus optional in-sample one-liner)
  fit36_rf        <- ranger(
    formula                   = f36,
    data                      = cf36,
    num.trees                 = 500,
    respect.unordered.factors = "order",
    seed                      = 2025
  )
  oob_mse36_rf    <- fit36_rf$prediction.error
  mse36_rf_insamp <- mean((predict(fit36_rf, cf36)$predictions - cf36$Y)^2)

  # 5) Bootstrap SE of CF-regression ATE (B = 500)
  B            <- 500
  boot_cf36    <- numeric(0)
  while (length(boot_cf36) < B) {
    idx    <- sample(nrow(cf36_cf), replace = TRUE)
    bdf    <- cf36_cf[idx, ]
    fit_b  <- lm(update(f36, . ~ . + Z1 + Z0), data = bdf)
    coefs  <- coef(fit_b)
    cf_try <- coefs["A"] +
              coefs["Z1"] * mean(bdf$Z1) -
              coefs["Z0"] * mean(bdf$Z0)
    if (!is.na(cf_try)) boot_cf36 <- c(boot_cf36, cf_try)
  }
  se36_cf_boot <- sd(boot_cf36)

  # Store results: in-sample MSEs for LM/CF, HAIPW SE, RF OOB MSE
  store_results(
    "36",
    beta36,
    se36_beta,
    mse36_anc,
    mse36_cf,
    res36$se,
    oob_mse36_rf
  )

  # Append CF bootstrap SE
  se_list[["36"]] <- bind_rows(
    se_list[["36"]],
    tibble(Trial = "36", Estimator = "CF Bootstrap", SE = se36_cf_boot)
  )
}

# Inspect
cat("ANCOVA in-sample MSE: ", round(mse36_anc,   3), "\n")
cat("CF    in-sample MSE: ", round(mse36_cf,    3), "\n")
cat("RF    OOB   MSE: ",      round(oob_mse36_rf, 3), "\n")

```


```{r summary_and_plots, message=FALSE, warning=FALSE}
{
  library(dplyr)
  library(xtable)
  library(ggplot2)

  # 1) Combine results
  mse_all <- bind_rows(mse_list)
  se_all  <- bind_rows(se_list)

  # 2) Sample sizes
  sample_size <- tibble(
    Trial = c("2","4","6","14","17","18","19","26","33","36"),
    N     = c(
      nrow(df2), nrow(df4), nrow(cf6), nrow(df14),
      nrow(df17), nrow(cf18), nrow(df19), nrow(df26),
      nrow(cf33), nrow(cf36)
    )
  )

  # 3) Build MSE table
  mse_tab <- mse_all %>%
    group_by(Trial) %>%
    summarise(
      ANCOVA_MSE = MSE[Model == "ANCOVA"],
      CF_MSE     = MSE[Model == "Counterfactual Reg."],
      RF_MSE     = MSE[Model == "Random Forest (OOB)"]
    ) %>%
    left_join(sample_size, by = "Trial") %>%
    mutate(
      Rel.Reduction = 100 * (ANCOVA_MSE - CF_MSE) / ANCOVA_MSE
    ) %>%
    select(Trial, N, ANCOVA_MSE, CF_MSE, RF_MSE, Rel.Reduction)

  # 4) Build SE table
  se_tab <- se_all %>%
    group_by(Trial) %>%
    summarise(
      ANCOVA_SE  = SE[Estimator == "ANCOVA beta"],
      HAIPW_SE   = SE[Estimator == "HAIPW ATE"],
      CF_SE_Boot = SE[Estimator == "CF Bootstrap"]
    ) %>%
    left_join(sample_size, by = "Trial") %>%
    select(Trial, N, ANCOVA_SE, HAIPW_SE, CF_SE_Boot)

  # 5) Print MSE table
  cat("## Pooled MSE Summary\n")
  print(
    xtable(
      mse_tab,
      digits = c(0,0,0,3,3,3,2),
      caption = "In-Sample ANCOVA/CF MSE, RF OOB MSE, and % Reduction"
    ),
    include.rownames = FALSE,
    booktabs = TRUE,
    sanitize.text.function = identity
  )

  # 6) Print SE table
  cat("\n## Pooled SE Summary\n")
  print(
    xtable(
      se_tab,
      digits = c(0,0,0,3,3,3),
      caption = "ANCOVA SE, HAIPW SE, and CF-Bootstrap SE"
    ),
    include.rownames = FALSE,
    booktabs = TRUE,
    sanitize.text.function = identity
  )

}
```


```{r}

  # 7) Boxplot: ANCOVA vs CF MSE
  box1_df <- mse_tab %>%
    pivot_longer(
      cols = c(ANCOVA_MSE, CF_MSE),
      names_to = "Model",
      values_to = "MSE"
    ) %>%
    left_join(sample_size, by = "Trial")
ggplot(box1_df, aes(x = Model, y = MSE)) +
  geom_boxplot(fill = "grey80") +
  geom_jitter(aes(size = N.x), width = .1, alpha = 0.6) +
  scale_y_log10() +
  labs(
    y = "MSE (log scale)",
    title = "ANCOVA vs CF, log (MSE)"
  ) +
  theme_minimal()

```

```{r}
  # 8) Boxplot: RF OOB vs CF MSE
  box2_df <- mse_tab %>%
    pivot_longer(
      cols = c(RF_MSE, CF_MSE),
      names_to = "Model",
      values_to = "MSE"
    ) %>%
    left_join(sample_size, by = "Trial")

  ggplot(box2_df, aes(x = Model, y = MSE)) +
    geom_boxplot(fill = "lightblue") +
    geom_jitter(aes(size = N.x), width = 0.1, color = "black", alpha = 0.6) +
    scale_y_log10() +
    labs(
      x = "Model",
      y = "MSE",
      title = "Random Forest OOB vs Counterfactual Regression MSE"
    ) +
    theme_minimal()

```
